/*
Comecero Cart version: ï»¿1.2.0
https://comecero.com
https://github.com/comecero/cart
Copyright Comecero and other contributors. Released under MIT license. See LICENSE for details.
*/

app.controller("TitleController",["$scope","SettingsService",function(e,t){var a=t.get().app;e.title=a.page_title||"Checkout"}]),app.directive("customHtml",function(){return{restrict:"AE",scope:{html:"=?"},link:function(e,t,a,i){e.html&&t.html(e.html)}}}),app.controller("InvoiceController",["$scope","$location","InvoiceService","GeoService","CurrencyService","HelperService","SettingsService","$document",function(e,t,a,i,r,o,n,d){e.data={},e.geoService=i,e.helpers=o,e.settings=n.get(),e.data.params={},e.data.params.expand="items.product,items.subscription_terms,customer.payment_methods,options",e.data.params.hide="items.product.formatted,items.product.prices,items.product.url,items.product.description,items.product.images.link_medium,items.product.images.link_large,items.product.images.link,items.product.images.filename,items.product.images.formatted,items.product.images.url,items.product.images.date_created,items.product.images.date_modified",e.data.payment_method={},e.data.payment_method={type:"credit_card"},e.data.amazon_pay={type:"amazon_pay"},e.data.paypal={type:"paypal",data:{success_url:window.location.href.substring(0,window.location.href.indexOf("#"))+"#/review/{{payment_id}}",cancel_url:window.location.href.substring(0,window.location.href.indexOf("#"))+"#/invoice"}},a.get(e.data.params).then(function(t){e.data.invoice=t,e.showImages=!1;var a=0;_.each(t.items,function(e){null!=e.product&&e.product.images.length>0&&a++}),a==t.items.length&&(e.showImages=!0);var i=((t.customer||{}).payment_methods||{}).data;i&&i.length>0&&(e.data.payment_method={payment_method_id:_.find(t.customer.payment_methods.data,function(e){return 1==e.is_default}).payment_method_id})},function(t){e.data.error=t}),e.onPaymentSuccess=function(e){"paypal"==e.payment_method.type&&"initiated"==e.status?window.location=e.response_data.redirect_url:"amazon_pay"==e.payment_method.type?t.path("/review/"+e.payment_id):t.path("/receipt/"+e.payment_id)},e.setPaymentMethod=function(t,a){e.data.payment_method={},t&&(e.data.payment_method.payment_method_id=t),a&&(e.data.payment_method.type=a)},e.$watch("data.error",function(t,a){e.data.error&&d.scrollTop(0,500)})}]),app.controller("CartController",["$scope","$location","CartService","GeoService","CurrencyService","SettingsService","HelperService","$document","$timeout",function(e,t,a,i,r,o,n,d,s){function c(t){e.showImages=!0,_.each(t.items,function(t){0==t.product.images.length&&(e.showImages=!1)})}e.data={},e.geoService=i,e.settings=o.get(),e.helpers=n,e.data.params={},e.data.params.expand="items.product,items.subscription_terms,customer.payment_methods,options",e.data.params.hide="items.product.formatted,items.product.prices,items.product.url,items.product.description,items.product.images.link_medium,items.product.images.link_large,items.product.images.link,items.product.images.filename,items.product.images.formatted,items.product.images.url,items.product.images.date_created,items.product.images.date_modified",e.data.shipping_is_billing=!0,e.data.payment_method={type:"credit_card"},e.data.amazon_pay={type:"amazon_pay"},e.data.paypal={type:"paypal",data:{success_url:window.location.href.substring(0,window.location.href.indexOf("#"))+"#/review/{{payment_id}}",cancel_url:window.location.href.substring(0,window.location.href.indexOf("#"))+"#/cart"}},a.get().then(function(i){i=a.fromParams(i,t),a.update(i,e.data.params,!1,!0).then(function(t){e.data.cart=t,c(e.data.cart),e.data.shipping_is_billing=!n.hasShippingAddress(t.customer);var a=((t.customer||{}).payment_methods||{}).data;a&&a.length>0&&(e.data.payment_method={payment_method_id:_.find(t.customer.payment_methods.data,function(e){return 1==e.is_default}).payment_method_id})},function(t){e.data.error=t})},function(t){e.data.error=t});var m;e.changeQuantity=function(t,i,r){m&&s.cancel(m),i?"+"==i?t.quantity++:t.quantity--:null!==r&&(t.quantity=r),0==t.quantity&&(e.data.cart.items=_.reject(e.data.cart.items,function(e){return e.item_id==t.item_id})),0==e.data.cart.items.length&&(e.data.error=null),m=s(function(){a.update(e.data.cart,e.data.params).then(function(t){e.data.cart=t,c(e.data.cart)},function(t){e.data.error=t})},500)},e.onPaymentSuccess=function(e){"paypal"==e.payment_method.type&&"initiated"==e.status?window.location=e.response_data.redirect_url:"amazon_pay"==e.payment_method.type?t.path("/review/"+e.payment_id):t.path("/receipt/"+e.payment_id)},e.onSignOut=function(){e.data.payment_method&&(e.data.payment_method.payment_method_id=null,e.data.payment_method.type="credit_card")},e.setPaymentMethod=function(t,a){e.data.payment_method={},t&&(e.data.payment_method.payment_method_id=t),a&&(e.data.payment_method.type=a)},e.$watch("data.error",function(t,a){e.data.error&&d.scrollTop(0,500)})}]),app.controller("ProductsController",["$scope","$routeParams","$location","$document","ProductService","CartService","GeoService","CurrencyService","SettingsService",function(e,t,a,i,r,o,n,d,s){e.data={},e.geo=n.getData(),e.settings=s.get(),e.data.params={},e.data.params.expand="items.product,items.subscription_terms,customer.payment_methods",e.data.params.show="product_id,name,price,currency,description,images.*",e.data.params.currency=d.getCurrency(),e.data.params.formatted=!0,e.data.params.limit=50,r.getList(e.data.params).then(function(t){e.data.products=t},function(t){e.data.error=t}),e.onAddToCart=function(e){a.path("/cart")},e.$watch("data.error",function(t,a){e.data.error&&i.scrollTop(0,500)})}]),app.controller("ReceiptController",["$scope","$routeParams","PaymentService","OrderService","SettingsService","HelperService","$document",function(e,t,a,i,r,o,n){e.data={},e.helpers=o,e.settings=r.get(),e.data.params={},e.data.params.expand="payment_method,payment_method.data,order.customer,order.items.product,order.items.subscription,order.options,cart.options,invoice.options",e.data.params.show="payment_method.*,payment_method.data.*,date_created,order.order_id,order.subtotal,order.total,order.tax,order.discount,order.currency,order.customer.name,order.tax_inclusive,order.customer.customer_id,order.customer.email,order.customer.username,order.customer.billing_address.*,order.items.item_id,order.items.quantity,order.items.price,order.items.price_original,order.items.subtotal,order.items.subtotal_original,order.items.total,order.items.total_original,order.items.name,order.items.subscription.description,order.items.type,order.items.license_pending,order.shipping_item.quantity,order.shipping_item.name,order.shipping_item.price,order.shipping_item.price_original,order.shipping_item.subtotal,order.shipping_item.subtotal_original,order.shipping_item.total,order.shipping_item.total_original,order.items.product.images.link_square,order.items.product.images.link_small,order.options.customer_optional_fields,order,cart.options.*,invoice.options.customer_optional_fields",1==r.get().app.show_digital_delivery&&(e.data.params.expand+=",order.items.download,order.items.license",e.data.params.show+=",order.items.item_id,order.items.license.html,order.items.license.label,order.items.license.instructions,order.items.download.link"),e.data.params.options=!0,e.data.params.formatted=!0,e.customer={},e.awaitingLicense=!1,a.get(t.id,e.data.params).then(function(t){e.showImages=!1;var a=0;_.each(t.order.items,function(e){null!=e.product&&e.product.images.length>0&&a++}),a==t.order.items.length&&(e.showImages=!0),t.cart?e.options=t.cart.options:e.options=t.invoice.options,e.data.payment=t,window.__conversion&&window.__conversion.recordConversion&&window.__conversion.recordConversion(t.order.order_id),setTimeout(function(){d(t.order.order_id)},1e3)},function(t){e.exception=t});var d=function(t,a){if(0!=r.get().app.show_digital_delivery&&null!=e.data.payment.order){if(a=a||0,_.where(e.data.payment.order.items,{license_pending:!0}).length>0?e.data.awaitingLicense=!0:e.data.awaitingLicense=!1,0==e.data.awaitingLicense||a>3)return void e.$apply(function(){e.data.awaitingLicense=!1});var o={show:"items.item_id,items.license.*",expand:"items.license"};i.get(t,o).then(function(i){return _.each(i.items,function(t){t.license&&(_.find(e.data.payment.order.items,function(e){return e.item_id==t.item_id}).license=t.license)}),0==_.where(e.data.payment.order.items,{type:"digital",license:null,download:null}).length?void(e.data.awaitingLicense=!1):(a++,void setTimeout(function(){d(t,a)},3500))})}};e.$watch("data.error",function(t,a){e.data.error&&n.scrollTop(0,500)})}]),app.controller("ReviewController",["$scope","$location","$routeParams","CartService","PaymentService","SettingsService","HelperService","GeoService","$document",function(e,t,a,i,r,o,n,d,s){e.data={},e.options={};t.search();e.data.payment_id=a.id,e.data.payment_id||t.path("/cart"),e.settings=o.get(),e.helpers=n,e.geoService=d,e.data.params={},e.data.params.expand="cart.items.product,cart.items.subscription_terms,invoice.items.product,invoice.items.subscription_terms,cart.options,invoice.options",e.data.params.hide="cart.items.product.formatted,cart.items.product.prices,cart.items.product.url,cart.items.product.description,cart.items.product.images.link_medium,cart.items.product.images.link_large,cart.items.product.images.link,cart.items.product.images.filename,cart.items.product.images.formatted,cart.items.product.images.url,cart.items.product.images.date_created,cart.items.product.images.date_modified,invoice.items.product.formatted,invoice.items.product.prices,invoice.items.product.url,invoice.items.product.description,invoice.items.product.images.link_medium,invoice.items.product.images.link_large,invoice.items.product.images.link,invoice.items.product.images.filename,invoice.items.product.images.formatted,invoice.items.product.images.url,invoice.items.product.images.date_created,invoice.items.product.images.date_modified",e.data.saleParams={expand:utils.deDuplicateCsv(e.data.params.expand.replaceAll("cart.","").replaceAll("invoice.","")),hide:utils.deDuplicateCsv(e.data.params.hide.replaceAll("cart.","").replaceAll("invoice.",""))},r.get(e.data.payment_id,e.data.params).then(function(a){"completed"!=a.status&&"pending"!=a.status||t.path("/receipt/"+a.payment_id),e.data.sale=a.cart||a.invoice,a.cart&&(e.options.isCartPayment=!0),e.showImages=!1;var i=0;_.each(e.data.sale.items,function(e){null!=e.product&&e.product.images.length>0&&i++}),i==e.data.sale.items.length&&(e.showImages=!0),n.isRequiredCustomerField("company_name",e.data.sale.options)&&null==e.data.sale.customer.company_name&&(e.options.showCompanyName=!0),n.isRequiredCustomerField("phone",e.data.sale.options)&&null==e.data.sale.customer.phone&&(e.options.showPhone=!0)},function(t){e.data.error=t}),e.onPaymentSuccess=function(e){"initiated"==e.status?window.location.replace(e.response_data.redirect_url):t.path("/receipt/"+e.payment_id)},e.$watch("data.error",function(t,a){e.data.error&&s.scrollTop(0,500)})}]);