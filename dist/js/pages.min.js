/*
Comecero Cart version: ï»¿2.2.0
https://comecero.com
https://github.com/comecero/cart
Copyright Comecero and other contributors. Released under MIT license. See LICENSE for details.
*/

app.controller("TitleController",["$scope","SettingsService",function(t,e){var a=e.get().app;t.title=a.page_title||"Checkout"}]),app.directive("customHtml",function(){return{restrict:"AE",scope:{html:"=?"},link:function(t,e,a,i){t.html&&e.html(t.html)}}}),app.directive("downloadReceipt",["ApiService",function(t){return{restrict:"A",scope:{orderId:"=?",orderUrl:"=?",error:"=?"},link:function(e,a,i){a.bind("click",function(){t.getItemPdf(e.orderUrl).then(function(t){var a=new Blob([t.data],{type:"application/pdf"});saveAs(a,"Order_"+e.orderId+".pdf")},function(t){e.error=t})})}}}]),app.controller("CartController",["$scope","$location","CartService","GeoService","CurrencyService","SettingsService","HelperService","$document","$timeout","$uibModal",function(t,e,a,i,r,o,n,s,d,c){function p(e){t.showImages=!0,_.each(e.items,function(e){0==e.product.images.length&&(t.showImages=!1)})}function m(e,a,i){if(e&&t.data.cart.up_sells&&t.data.cart.up_sells.total_items&&null==utils.getCookie("upsell-"+t.data.cart.cart_id)){utils.setCookie("upsell-"+t.data.cart.cart_id,!0,60),i||(i=0),i=1e3*i;var r="app/templates/upsell-"+e;"cart_load"==a&&(r+="-load"),r+=".html",l=d(function(){t.upsellModal=c.open({size:"md",templateUrl:r,scope:t})},i)}}t.data={},t.options={payment_method:"credit_card"},t.geoService=i,t.settings=o.get(),t.helpers=n,t.data.params={},t.data.params.expand="items.product,items.subscription_terms,customer.payment_methods,options",t.settings.app.cross_sell_items&&Number(t.settings.app.cross_sell_items)&&(t.data.params.expand+=",cross_sells.product"),t.settings.app.upsell_trigger&&"disable"!=t.settings.app.upsell_trigger&&(t.data.params.expand+=",up_sells.product,up_sells.up_sell_from_product"),t.data.params.hide="items.product.formatted,items.product.prices,items.product.url,items.product.description,items.product.images.link_medium,items.product.images.link_large,items.product.images.link,items.product.images.filename,items.product.images.formatted,items.product.images.url,items.product.images.date_created,items.product.images.date_modified",t.data.shipping_is_billing=!0,t.data.credit_card={type:"credit_card"},t.data.amazon_pay={type:"amazon_pay"},t.data.paypal={type:"paypal",data:{success_url:window.location.href.substring(0,window.location.href.indexOf("#"))+"#/review/{{payment_id}}",cancel_url:window.location.href.substring(0,window.location.href.indexOf("#"))+"#/cart"}},t.data.payment_method=t.data.credit_card,a.get().then(function(i){i=a.fromParams(i,e),a.update(i,t.data.params,!1,!0).then(function(e){t.data.cart=e,p(t.data.cart),t.data.shipping_is_billing=!n.hasShippingAddress(e.customer);var a=((e.customer||{}).payment_methods||{}).data;a&&a.length>0&&(t.data.payment_method={payment_method_id:_.find(e.customer.payment_methods.data,function(t){return 1==t.is_default}).payment_method_id}),"cart_load"==t.settings.app.upsell_trigger&&m(t.settings.app.upsell_type,t.settings.app.upsell_trigger,t.settings.app.upsell_delay)},function(e){t.data.error=e})},function(e){t.data.error=e});var u;t.changeQuantity=function(e,i,r){u&&d.cancel(u),i?"+"==i?e.quantity++:e.quantity>0&&e.quantity--:null!==r&&(e.quantity=r),0==e.quantity&&(t.data.cart.items=_.reject(t.data.cart.items,function(t){return t.item_id==e.item_id})),0==t.data.cart.items.length&&(t.data.error=null),u=d(function(){a.update(t.data.cart,t.data.params).then(function(e){t.data.cart=e,p(t.data.cart)},function(e){t.data.error=e})},200)},t.onPaymentSuccess=function(t){"paypal"==t.payment_method.type&&"initiated"==t.status?window.location=t.response_data.redirect_url:"amazon_pay"==t.payment_method.type?e.path("/review/"+t.payment_id):e.path("/receipt/"+t.payment_id)},t.onSignOut=function(){t.data.payment_method&&(t.data.payment_method.payment_method_id=null,t.data.payment_method.type="credit_card")},t.setPaymentMethod=function(e,a){t.data.payment_method={},e&&(t.data.payment_method.payment_method_id=e),a&&(t.data.payment_method.type=a)},t.showElectronicDelivery=function(t,e){return(1!=t.items.length||!t.shipping_item)&&("digital"==e.product.type||!("service"!=e.product.type||!e.product.has_file&&!e.product.has_license_service))},t.showPhysicalDelivery=function(t,e){return!("physical"!=e.product.type||!t.shipping_item)},t.onPaymentValidationSuccess=function(){if("payment_submit"==t.settings.app.upsell_trigger&&t.data.cart.up_sells&&t.data.cart.up_sells.data&&t.data.cart.up_sells.data.length&&null==utils.getCookie("upsell-"+t.data.cart.cart_id))return m(t.settings.app.upsell_type,t.settings.app.upsell_trigger),!1};var l;t.closeUpsell=function(){t.upsellModal&&t.upsellModal.dismiss()},t.commitUpsellAndPay=function(e,i){if(i){var r=document.getElementById(i);r&&(r.disabled=!0)}var o=angular.copy(t.data.cart),n=_.find(t.data.cart.items,function(t){return t.item_id==e.up_sell_from_product.product_id});o.items.push({product_id:e.product_id,up_sell_id:e.up_sell_id,quantity:n.quantity}),o.items=_.reject(o.items,function(t){return t.product_id==n.product_id}),a.pay(o,t.data.payment_method,null,t.data.params).then(function(e){t.data.cart=o,t.onPaymentSuccess(e),t.closeUpsell()},function(e){t.data.cart=o,t.data.error=e})},t.commitUpsell=function(e){var i=angular.copy(t.data.cart),r=_.find(t.data.cart.items,function(t){return t.item_id==e.up_sell_from_product.product_id});i.items.push({product_id:e.product_id,up_sell_id:e.up_sell_id,quantity:r.quantity}),i.items=_.reject(i.items,function(t){return t.product_id==r.product_id}),a.update(i,t.data.params).then(function(e){t.data.cart=e,t.closeUpsell()},function(e){t.data.error=e})},t.$watch("data.error",function(e,a){t.data.error&&(t.closeUpsell(),s.scrollTop(0,500))}),t.$watch("options.payment_method",function(e,a){e&&(t.data.payment_method=t.data[e])}),t.$on("$destroy",function(){angular.isDefined(u)&&d.cancel(u),angular.isDefined(l)&&d.cancel(l)})}]),app.controller("InvoiceController",["$scope","$location","InvoiceService","GeoService","CurrencyService","HelperService","SettingsService","$document",function(t,e,a,i,r,o,n,s){t.data={},t.options={payment_method:"credit_card"},t.geoService=i,t.helpers=o,t.settings=n.get(),t.data.params={},t.data.params.expand="items.product,items.subscription_terms,customer.payment_methods,options",t.data.params.hide="items.product.formatted,items.product.prices,items.product.url,items.product.description,items.product.images.link_medium,items.product.images.link_large,items.product.images.link,items.product.images.filename,items.product.images.formatted,items.product.images.url,items.product.images.date_created,items.product.images.date_modified",t.data.payment_method={},t.data.payment_method={type:"credit_card"},t.data.amazon_pay={type:"amazon_pay"},t.data.paypal={type:"paypal",data:{success_url:window.location.href.substring(0,window.location.href.indexOf("#"))+"#/review/{{payment_id}}",cancel_url:window.location.href.substring(0,window.location.href.indexOf("#"))+"#/invoice"}},a.get(t.data.params).then(function(e){t.data.invoice=e,t.showImages=!1;var a=0;_.each(e.items,function(t){null!=t.product&&t.product.images.length>0&&a++}),a==e.items.length&&(t.showImages=!0);var i=((e.customer||{}).payment_methods||{}).data;i&&i.length>0&&(t.data.payment_method={payment_method_id:_.find(e.customer.payment_methods.data,function(t){return 1==t.is_default}).payment_method_id})},function(e){t.data.error=e}),t.onPaymentSuccess=function(t){"paypal"==t.payment_method.type&&"initiated"==t.status?window.location=t.response_data.redirect_url:"amazon_pay"==t.payment_method.type?e.path("/review/"+t.payment_id):e.path("/receipt/"+t.payment_id)},t.setPaymentMethod=function(e,a){t.data.payment_method={},e&&(t.data.payment_method.payment_method_id=e),a&&(t.data.payment_method.type=a)},t.$watch("data.error",function(e,a){t.data.error&&s.scrollTop(0,500)})}]),app.controller("ProductsController",["$scope","$routeParams","$location","$document","ProductService","CartService","GeoService","CurrencyService","SettingsService",function(t,e,a,i,r,o,n,s,d){t.data={},t.geo=n.getData(),t.settings=d.get(),t.data.params={},t.data.params.expand="items.product,items.subscription_terms,customer.payment_methods",t.data.params.show="product_id,name,price,currency,description,images.*",t.data.params.currency=s.getCurrency(),t.data.params.formatted=!0,t.data.params.limit=50,r.getList(t.data.params).then(function(e){t.data.products=e},function(e){t.data.error=e}),t.onAddToCart=function(t){a.path("/cart")},t.$watch("data.error",function(e,a){t.data.error&&i.scrollTop(0,500)})}]),app.controller("ReceiptController",["$scope","$routeParams","PaymentService","OrderService","SettingsService","HelperService","$document","$interpolate",function(t,e,a,i,r,o,n,s){t.data={},t.helpers=o,t.settings=r.get(),t.data.params={},t.data.params.expand="payment_method,payment_method.data,order.customer,order.items.product,order.items.subscription_terms,order.options,cart.options,invoice.options",1==r.get().app.show_digital_delivery&&(t.data.params.expand+=",order.items.download,order.items.license"),t.data.params.options=!0,t.data.params.formatted=!0,t.customer={},t.awaitingLicense=!1,a.get(e.id,t.data.params).then(function(e){t.showImages=!1;var a=0;_.each(e.order.items,function(t){null!=t.product&&t.product.images.length>0&&a++}),a==e.order.items.length&&(t.showImages=!0),e.cart?t.options=e.cart.options:t.options=e.invoice.options,t.data.payment=e,window.__conversion&&window.__conversion.recordConversion&&window.__conversion.recordConversion(e.order.order_id),setTimeout(function(){d(e.order.order_id)},1e3)},function(e){t.exception=e});var d=function(e,a){if(0!=r.get().app.show_digital_delivery&&null!=t.data.payment.order){if(a=a||0,_.where(t.data.payment.order.items,{license_pending:!0}).length>0?t.data.awaitingLicense=!0:t.data.awaitingLicense=!1,0==t.data.awaitingLicense||a>3)return void t.$apply(function(){t.data.awaitingLicense=!1});var o={show:"items.item_id,items.license.*",expand:"items.license"};i.get(e,o).then(function(i){return _.each(i.items,function(e){e.license&&(_.find(t.data.payment.order.items,function(t){return t.item_id==e.item_id}).license=e.license)}),0==_.where(t.data.payment.order.items,{type:"digital",license:null}).length?void(t.data.awaitingLicense=!1):(a++,void setTimeout(function(){d(e,a)},3500))})}};t.getReceiptButtonUrl=function(e){if(t.data&&t.data.payment){var a={payment:t.data.payment,order:t.data.payment.order};return e?s(e)(a):t.settings.app.main_shopping_url||window.location.href.substring(0,window.location.href.indexOf("#"))+"#/"}},t.$watch("data.error",function(e,a){t.data.error&&n.scrollTop(0,500)})}]),app.controller("ReviewController",["$scope","$location","$routeParams","CartService","PaymentService","SettingsService","HelperService","GeoService","$document",function(t,e,a,i,r,o,n,s,d){function c(t){var e=t.cart||payemnt.invoice;return!(t.total<e.total)&&(!(e.options.shipping_quotes.length>1)&&(!!n.hasRequiredFields(e.customer,e.options)&&(!(e.customer.company_name&&!e.customer.tax_number&&(s.isEu(e.customer.billing_address.country)||s.isEu(e.customer.shipping_address.country)))&&!o.get().app.fields)))}t.data={},t.options={},t.showLoader=!0;e.search();t.data.payment_id=a.id,t.data.payment_id||e.path("/cart"),t.settings=o.get(),t.helpers=n,t.geoService=s,t.data.params={},t.data.params.expand="cart.items.product,cart.items.subscription_terms,invoice.items.product,invoice.items.subscription_terms,cart.options,invoice.options",t.data.params.hide="cart.items.product.formatted,cart.items.product.prices,cart.items.product.url,cart.items.product.description,cart.items.product.images.link_medium,cart.items.product.images.link_large,cart.items.product.images.link,cart.items.product.images.filename,cart.items.product.images.formatted,cart.items.product.images.url,cart.items.product.images.date_created,cart.items.product.images.date_modified,invoice.items.product.formatted,invoice.items.product.prices,invoice.items.product.url,invoice.items.product.description,invoice.items.product.images.link_medium,invoice.items.product.images.link_large,invoice.items.product.images.link,invoice.items.product.images.filename,invoice.items.product.images.formatted,invoice.items.product.images.url,invoice.items.product.images.date_created,invoice.items.product.images.date_modified",t.data.saleParams={expand:utils.deDuplicateCsv(t.data.params.expand.replaceAll("cart.","").replaceAll("invoice.","")),hide:utils.deDuplicateCsv(t.data.params.hide.replaceAll("cart.","").replaceAll("invoice.",""))},r.get(t.data.payment_id,t.data.params).then(function(a){"completed"!=a.status&&"pending"!=a.status||e.path("/receipt/"+a.payment_id),c(a)?r.commit(a.payment_id,t.data.params).then(function(t){e.path("/receipt/"+t.payment_id)},function(e){t.data.error=e,t.showLoader=!1}):t.showLoader=!1,t.data.sale=a.cart||a.invoice,a.cart&&(t.options.isCartPayment=!0),t.showImages=!1;var i=0;_.each(t.data.sale.items,function(t){null!=t.product&&t.product.images.length>0&&i++}),i==t.data.sale.items.length&&(t.showImages=!0),n.isRequiredCustomerField("company_name",t.data.sale.options)&&null==t.data.sale.customer.company_name&&(t.options.showCompanyName=!0),n.isRequiredCustomerField("phone",t.data.sale.options)&&null==t.data.sale.customer.phone&&(t.options.showPhone=!0)},function(e){t.data.error=e}),t.onPaymentSuccess=function(t){"initiated"==t.status?window.location.replace(t.response_data.redirect_url):e.path("/receipt/"+t.payment_id)},t.showElectronicDelivery=function(t,e){return(1!=t.items.length||!t.shipping_item)&&("digital"==e.product.type||!("service"!=e.product.type||!e.product.has_file&&!e.product.has_license_service))},t.showPhysicalDelivery=function(t,e){return!("physical"!=e.product.type||!t.shipping_item)},t.$watch("data.error",function(e,a){t.data.error&&d.scrollTop(0,500)})}]);