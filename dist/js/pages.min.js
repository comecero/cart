/*
Comecero Cart version: ï»¿2.2.5

https://comecero.com
https://github.com/comecero/cart
Copyright Comecero and other contributors. Released under MIT license. See LICENSE for details.
*/

app.controller("TitleController",["$scope","SettingsService",function(t,e){e=e.get().app;t.title=e.page_title||"Checkout"}]),app.directive("customHtml",function(){return{restrict:"AE",scope:{html:"=?"},link:function(t,e,a,i){t.html&&e.html(t.html)}}}),app.directive("downloadReceipt",["ApiService",function(i){return{restrict:"A",scope:{orderId:"=?",orderUrl:"=?",error:"=?"},link:function(e,t,a){t.bind("click",function(){i.getItemPdf(e.orderUrl).then(function(t){t=new Blob([t.data],{type:"application/pdf"});saveAs(t,"Order_"+e.orderId+".pdf")},function(t){e.error=t})})}}}]),app.controller("CartController",["$scope","$location","CartService","GeoService","CurrencyService","SettingsService","HelperService","StorageService","$document","$timeout","$uibModal",function(r,e,n,t,a,i,o,d,s,c,p){var m,u;function l(t){r.showImages=!0,_.each(t.items,function(t){0==t.product.images.length&&(r.showImages=!1)})}function g(t,e,a){var i;t&&r.data.cart.up_sells&&r.data.cart.up_sells.total_items&&null==utils.getCookie("upsell-"+r.data.cart.cart_id)&&(utils.setCookie("upsell-"+r.data.cart.cart_id,!0,60),a=a||0,i="app/templates/upsell-"+t,"cart_load"==e&&(i+="-load"),i+=".html",u=c(function(){r.upsellModal=p.open({size:"md",templateUrl:i,scope:r})},a*=1e3))}r.data={},r.options={payment_method:"credit_card"},r.geoService=t,r.settings=i.get(),r.helpers=o,r.data.params={},r.data.params.expand="items.product,items.subscription_terms,customer.payment_methods,options,options.user_agent_payment_request",r.settings.app.cross_sell_items&&Number(r.settings.app.cross_sell_items)&&(r.data.params.expand+=",cross_sells.product"),r.settings.app.upsell_trigger&&"disable"!=r.settings.app.upsell_trigger&&(r.data.params.expand+=",up_sells.product,up_sells.up_sell_from_product"),r.data.params.hide="items.product.prices,items.product.url,items.product.description,items.product.images.link_medium,items.product.images.link_large,items.product.images.link,items.product.images.filename,items.product.images.formatted,items.product.images.url,items.product.images.date_created,items.product.images.date_modified",r.data.shipping_is_billing=!0,r.data.credit_card={type:"credit_card"},r.data.amazon_pay={type:"amazon_pay"},r.data.paypal={type:"paypal",data:{success_url:window.location.href.substring(0,window.location.href.indexOf("#"))+"#/review/{{payment_id}}",cancel_url:window.location.href.substring(0,window.location.href.indexOf("#"))+"#/cart"}},r.data.payment_method=r.data.credit_card,n.get().then(function(t){t=n.fromParams(t,e);var a=function(t){n.update(t,r.data.params,!1,!0).then(function(t){r.data.cart=t,l(r.data.cart),r.data.shipping_is_billing=!o.hasShippingAddress(t.customer);var e=((t.customer||{}).payment_methods||{}).data;e&&0<e.length&&(r.data.payment_method={payment_method_id:_.find(t.customer.payment_methods.data,function(t){return 1==t.is_default}).payment_method_id}),"cart_load"==r.settings.app.upsell_trigger&&g(r.settings.app.upsell_type,r.settings.app.upsell_trigger,r.settings.app.upsell_delay)},function(e){"insufficient_inventory"==(r.data.error=e).code&&(_.find(t.items,function(t){return t.product_id==e.meta.product_id}).quantity=e.meta.max_quantity,a(t)),"unavailable_inventory"==e.code&&(t.items=_.reject(t.items,function(t){return t.product_id==e.meta.product_id}),a(t))})};a(t)},function(t){r.data.error=t}),r.changeQuantity=function(e,t,a){m&&c.cancel(m),t?"+"==t?e.quantity++:0<e.quantity&&e.quantity--:null!==a&&(e.quantity=a),0==e.quantity&&(r.data.cart.items=_.reject(r.data.cart.items,function(t){return t.item_id==e.item_id})),0==r.data.cart.items.length&&(r.data.error=null),m=c(function(){var a=function(t,e){n.update(r.data.cart,r.data.params).then(function(t){r.data.cart=t,l(r.data.cart),e||(r.data.error=null)},function(e){"insufficient_inventory"==(r.data.error=e).code&&(_.find(t.items,function(t){return t.product_id==e.meta.product_id}).quantity=e.meta.max_quantity,a(t,!0)),"unavailable_inventory"==e.code&&(t.items=_.reject(t.items,function(t){return t.product_id==e.meta.product_id}),a(t,!0))})};a(r.data.cart)},0)},r.onPaymentSuccess=function(t){"paypal"==t.payment_method.type&&"initiated"==t.status?window.location=t.response_data.redirect_url:"amazon_pay"==t.payment_method.type?e.path("/review/"+t.payment_id):(e.path("/receipt/"+t.payment_id),d.remove("cart_id"))},r.onSignOut=function(){r.data.payment_method&&(r.data.payment_method.payment_method_id=null,r.data.payment_method.type="credit_card")},r.setPaymentMethod=function(t,e){r.data.payment_method={},t&&(r.data.payment_method.payment_method_id=t),e&&(r.data.payment_method.type=e)},r.showElectronicDelivery=function(t,e){return(1!=t.items.length||!t.shipping_item)&&("digital"==e.product.type||!("service"!=e.product.type||!e.product.has_file&&!e.product.has_license_service))},r.showPhysicalDelivery=function(t,e){return!("physical"!=e.product.type||!t.shipping_item)},r.onPaymentValidationSuccess=function(){if("payment_submit"==r.settings.app.upsell_trigger&&r.data.cart.up_sells&&r.data.cart.up_sells.data&&r.data.cart.up_sells.data.length&&null==utils.getCookie("upsell-"+r.data.cart.cart_id))return g(r.settings.app.upsell_type,r.settings.app.upsell_trigger),!1},r.closeUpsell=function(){r.upsellModal&&r.upsellModal.dismiss()},r.commitUpsellAndPay=function(e,t){!t||(t=document.getElementById(t))&&(t.disabled=!0);var a=angular.copy(r.data.cart),i=_.find(r.data.cart.items,function(t){return t.item_id==e.up_sell_from_product.product_id});a.items.push({product_id:e.product_id,up_sell_id:e.up_sell_id,quantity:i.quantity}),a.items=_.reject(a.items,function(t){return t.product_id==i.product_id}),n.pay(a,r.data.payment_method,null,r.data.params).then(function(t){r.data.cart=a,r.onPaymentSuccess(t),r.closeUpsell()},function(t){r.data.cart=a,r.data.error=t})},r.commitUpsell=function(e){var t=angular.copy(r.data.cart),a=_.find(r.data.cart.items,function(t){return t.item_id==e.up_sell_from_product.product_id});t.items.push({product_id:e.product_id,up_sell_id:e.up_sell_id,quantity:a.quantity}),t.items=_.reject(t.items,function(t){return t.product_id==a.product_id}),n.update(t,r.data.params).then(function(t){r.data.cart=t,r.closeUpsell()},function(t){r.data.error=t})},r.$watch("data.error",function(t,e){r.data.error&&(r.closeUpsell(),s.scrollTop(0,500))}),r.$watch("data.cart.customer.name",function(t,e){r.data.cart&&r.data.cart.customer&&(r.data.cart.customer.billing_address.name=t)}),r.$watch("options.payment_method",function(t,e){t&&(r.data.payment_method=r.data[t])}),r.$on("$destroy",function(){angular.isDefined(m)&&c.cancel(m),angular.isDefined(u)&&c.cancel(u)})}]),app.controller("InvoiceController",["$scope","$location","InvoiceService","GeoService","CurrencyService","HelperService","SettingsService","$document",function(i,e,t,a,r,n,o,d){i.data={},i.options={payment_method:"credit_card"},i.geoService=a,i.helpers=n,i.settings=o.get(),i.data.params={},i.data.params.expand="items.product,items.subscription_terms,customer.payment_methods,options",i.data.params.hide="items.product.formatted,items.product.prices,items.product.url,items.product.description,items.product.images.link_medium,items.product.images.link_large,items.product.images.link,items.product.images.filename,items.product.images.formatted,items.product.images.url,items.product.images.date_created,items.product.images.date_modified",i.data.payment_method={},i.data.payment_method={type:"credit_card"},i.data.amazon_pay={type:"amazon_pay"},i.data.paypal={type:"paypal",data:{success_url:window.location.href.substring(0,window.location.href.indexOf("#"))+"#/review/{{payment_id}}",cancel_url:window.location.href.substring(0,window.location.href.indexOf("#"))+"#/invoice"}},t.get(i.data.params).then(function(t){i.data.invoice=t,i.showImages=!1;var e=0;_.each(t.items,function(t){null!=t.product&&0<t.product.images.length&&e++}),e==t.items.length&&(i.showImages=!0);var a=((t.customer||{}).payment_methods||{}).data;a&&0<a.length&&(i.data.payment_method={payment_method_id:_.find(t.customer.payment_methods.data,function(t){return 1==t.is_default}).payment_method_id})},function(t){i.data.error=t}),i.onPaymentSuccess=function(t){"paypal"==t.payment_method.type&&"initiated"==t.status?window.location=t.response_data.redirect_url:"amazon_pay"==t.payment_method.type?e.path("/review/"+t.payment_id):e.path("/receipt/"+t.payment_id)},i.setPaymentMethod=function(t,e){i.data.payment_method={},t&&(i.data.payment_method.payment_method_id=t),e&&(i.data.payment_method.type=e)},i.$watch("data.error",function(t,e){i.data.error&&d.scrollTop(0,500)})}]),app.controller("ProductsController",["$scope","$routeParams","$location","$document","ProductService","CartService","GeoService","CurrencyService","SettingsService",function(a,t,e,i,r,n,o,d,s){a.data={},a.geo=o.getData(),a.settings=s.get(),a.data.params={},a.data.params.expand="items.product,items.subscription_terms,customer.payment_methods",a.data.params.show="product_id,name,price,currency,description,images.*",a.data.params.currency=d.getCurrency(),a.data.params.formatted=!0,a.data.params.limit=50,r.getList(a.data.params).then(function(t){a.data.products=t},function(t){a.data.error=t}),a.onAddToCart=function(t){e.path("/cart")},a.$watch("data.error",function(t,e){a.data.error&&i.scrollTop(0,500)})}]),app.controller("ReceiptController",["$scope","$routeParams","PaymentService","OrderService","SettingsService","HelperService","$document","$interpolate",function(i,t,e,r,n,a,o,d){i.data={},i.helpers=a,i.settings=n.get(),i.data.params={},i.data.params.expand="payment_method,payment_method.data,order.customer,order.items.product,order.items.subscription_terms,order.options,cart.options,invoice.options",1==n.get().app.show_digital_delivery&&(i.data.params.expand+=",order.items.download,order.items.license"),i.data.params.options=!0,i.data.params.formatted=!0,i.customer={},i.awaitingLicense=!1,e.get(t.id,i.data.params).then(function(t){var e,a;t.order&&i.settings.app.receipt_redirect_url&&(e=c(i.settings.app.receipt_redirect_url,t)),e?window.location.replace(e):(i.showImages=!1,a=0,_.each(t.order.items,function(t){null!=t.product&&0<t.product.images.length&&a++}),a==t.order.items.length&&(i.showImages=!0),t.cart?i.options=t.cart.options:i.options=t.invoice.options,i.data.payment=t,window.__conversion&&window.__conversion.recordConversion&&window.__conversion.recordConversion(t.order.order_id),setTimeout(function(){s(t.order.order_id)},1e3))},function(t){i.exception=t});var s=function(e,a){0!=n.get().app.show_digital_delivery&&null!=i.data.payment.order&&(a=a||0,0<_.where(i.data.payment.order.items,{license_pending:!0}).length?i.data.awaitingLicense=!0:i.data.awaitingLicense=!1,0==i.data.awaitingLicense||3<a?i.$apply(function(){i.data.awaitingLicense=!1}):r.get(e,{show:"items.item_id,items.license.*",expand:"items.license"}).then(function(t){_.each(t.items,function(e){e.license&&(_.find(i.data.payment.order.items,function(t){return t.item_id==e.item_id}).license=e.license)}),0!=_.where(i.data.payment.order.items,{type:"digital",license:null}).length?(a++,setTimeout(function(){s(e,a)},3500)):i.data.awaitingLicense=!1}))};function c(t,e){if(e){e={payment:e,order:e.order};return d(t)(e)}return null}i.getReceiptButtonUrl=function(t,e){return t?c(t,e):i.settings.app.main_shopping_url||window.location.href.substring(0,window.location.href.indexOf("#"))+"#/"},i.$watch("data.error",function(t,e){i.data.error&&o.scrollTop(0,500)})}]),app.controller("ReviewController",["$scope","$location","$routeParams","CartService","PaymentService","SettingsService","HelperService","GeoService","$document",function(a,i,t,e,r,n,o,d,s){a.data={},a.options={},a.showLoader=!0;i.search();a.data.payment_id=t.id,a.data.payment_id||i.path("/cart"),a.settings=n.get(),a.helpers=o,a.geoService=d,a.data.params={},a.data.params.expand="cart.items.product,cart.items.subscription_terms,invoice.items.product,invoice.items.subscription_terms,cart.options,invoice.options",a.data.params.hide="cart.items.product.formatted,cart.items.product.prices,cart.items.product.url,cart.items.product.description,cart.items.product.images.link_medium,cart.items.product.images.link_large,cart.items.product.images.link,cart.items.product.images.filename,cart.items.product.images.formatted,cart.items.product.images.url,cart.items.product.images.date_created,cart.items.product.images.date_modified,invoice.items.product.formatted,invoice.items.product.prices,invoice.items.product.url,invoice.items.product.description,invoice.items.product.images.link_medium,invoice.items.product.images.link_large,invoice.items.product.images.link,invoice.items.product.images.filename,invoice.items.product.images.formatted,invoice.items.product.images.url,invoice.items.product.images.date_created,invoice.items.product.images.date_modified",a.data.saleParams={expand:utils.deDuplicateCsv(a.data.params.expand.replaceAll("cart.","").replaceAll("invoice.","")),hide:utils.deDuplicateCsv(a.data.params.hide.replaceAll("cart.","").replaceAll("invoice.",""))},r.get(a.data.payment_id,a.data.params).then(function(t){"completed"!=t.status&&"pending"!=t.status||i.path("/receipt/"+t.payment_id),!function(t){var e=t.cart||t.invoice;if(t.total<e.total)return!1;if(1<e.options.shipping_quotes.length)return!1;if(!o.hasRequiredFields(e.customer,e.options))return!1;if(e.customer.company_name&&!e.customer.tax_number&&(d.isEu(e.customer.billing_address.country)||d.isEu(e.customer.shipping_address.country)))return!1;if(n.get().app.fields)return!1;return!0}(t)?a.showLoader=!1:r.commit(t.payment_id,a.data.params).then(function(t){i.path("/receipt/"+t.payment_id)},function(t){a.data.error=t,a.showLoader=!1}),a.data.sale=t.cart||t.invoice,t.cart&&(a.options.isCartPayment=!0),a.showImages=!1;var e=0;_.each(a.data.sale.items,function(t){null!=t.product&&0<t.product.images.length&&e++}),e==a.data.sale.items.length&&(a.showImages=!0),o.isRequiredCustomerField("company_name",a.data.sale.options)&&null==a.data.sale.customer.company_name&&(a.options.showCompanyName=!0),o.isRequiredCustomerField("phone",a.data.sale.options)&&null==a.data.sale.customer.phone&&(a.options.showPhone=!0)},function(t){a.data.error=t}),a.onPaymentSuccess=function(t){"initiated"==t.status?window.location.replace(t.response_data.redirect_url):i.path("/receipt/"+t.payment_id)},a.showElectronicDelivery=function(t,e){return(1!=t.items.length||!t.shipping_item)&&("digital"==e.product.type||!("service"!=e.product.type||!e.product.has_file&&!e.product.has_license_service))},a.showPhysicalDelivery=function(t,e){return!("physical"!=e.product.type||!t.shipping_item)},a.$watch("data.error",function(t,e){a.data.error&&s.scrollTop(0,500)})}]);